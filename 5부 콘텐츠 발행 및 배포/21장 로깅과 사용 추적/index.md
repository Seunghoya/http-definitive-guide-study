## 21장 로깅과 사용 추적

### 21.1 로그란 무엇인가?

- 서버나 프락시의 문제를 찾거나, 웹 사이트 접근 통계(마케팅, 청구, 장비 조달 계획을 세우기 위한)를 내려고 로깅을 한다.
- 기본적인 로깅 항목들
  - HTTP 메서드
  - 클라이언트와 서버의 HTTP 버전
  - 요청받은 리소스의 URL
  - 응답의 HTTP 상태 코드
  - 요청과 응답 메시지의 크기 (모든 엔터티 본문을 포함)
  - 트랜잭션이 일어난 시간
  - Referer와 User-Agent 헤더 값

### 21.2 로그 포맷

- 사용 혹은 오픈 소스 HTTP 애플리케이션은 대부분, 표준 로그 포맷 한 개 이상 지원한다.
- 애플리케이션이 더 많은 표준 포맷을 지원하고 관리자가 사용할 수록 얻는 이점들이 있다.
  - ex) 관리자가 지정한 필드를 포함한 로그 포맷을 통해 필요한 통계 추출 가능

#### 21.2.1 일반 로그 포맷(Common Log Format)

- 많은 서버가 기본으로 사용한다.
  ![일반 로그 포맷 필드](https://user-images.githubusercontent.com/74203440/212672641-e4a79dd9-8874-4ac2-96aa-6221e10b05e2.jpeg)

#### 21.2.2 혼합 로그 포맷(Combined Log Format)

- 많이 사용하는 로그 포맷이며, 아파치 같은 서퍼들이 지원한다.
- 추가된 2개의 필드를 제외하면 똑같다.
  ![혼합 로그 포맷에 추가된 필드](https://user-images.githubusercontent.com/74203440/212672656-53a35721-1294-4cdd-ab4e-db8e02070996.jpeg)

#### 21.2.3 넷스케이프 확장 로그 포맷

- 프락시나 웹 캐시 같은 HTTP 애플리케이션과 연관이 있는 여러 환경을 지원하려고 포맷을 확장했다.
  ![넷스케이프 확장 로그 포맷 필드](https://user-images.githubusercontent.com/74203440/212672691-ae264c1a-0c75-479e-b33d-09320b05a246.jpeg)

#### 21.2.4 넷스케이프 확장 2 로그 포맷

- 확장 로그 포맷에 추가된 필드가 있고 HTTP 클라이언트와 HTTP 프락시 애플리케이션 간의 통신을 설계하는데 도움이 된다.
  ![추가된 넷스케이프 확장 2 로그 포맷](https://user-images.githubusercontent.com/74203440/212672713-cd98eb3b-7a44-47a3-a7a5-a12655bfd2b0.jpeg)

#### 21.2.5 스퀴드 (Squid) 프락시 로그 포맷

- 스퀴드는 수년간 오픈 소스 커뮤니티를 통해 확장 및 개선되어 온 프로젝트이며, 스퀴드 애플리케이션을 관리하는데 도움이 되는 도구(처리, 추적, 로그 분석)를 활용하기 위해 스퀴드 포맷을 적용한다.
- 스퀴드는 기본적으로 HTTP와 FTP에 사용되지만 TLS, SSL, HTTPS 등과 같이 많은 프로토콜을 지원한다.
  ![스퀴드 로그 포맷 필드](https://user-images.githubusercontent.com/74203440/212672973-4afe94f5-849b-4e51-96a9-e65f4e0da50e.jpeg)

## 3. 적중 계량하기

- 클라이언트와 서버 사이에 캐시가 있기 때문에, 원 서버는 언제나 직접 로그 데이터를 작성할 수 없음
- 프록시 캐시에서 자체 로그를 유지하면 이 문제를 해결할 수 있을 것
- **Hit Metering** 규약은 HTTP의 확장으로, 캐시가 정기적으로 캐시 접근 통계를 원 서버에 보고하도록 함

### 3.1 개요

- 캐시와 서버가 접근 정보를 공유하고, 캐시 리소스의 양을 제어하는 몇 가지 기초적인 HTTP 확장 기능 정의
- 완벽한 해결책이 아니며, 널리 사용되고 있지는 않음
- 그럼에도 불구하고 접근 통계 정보를 취합할 수 있고, 캐시의 이점을 유지할 수 있음

### 3.2 Meter 헤더

- 캐시 및 서버는 Meter 헤더에 사용량이나 보고에 관한 지시자들을 기술할 수 있음

|        지시자         | 약어 | 주체 | 설명                                                  |
| :-------------------: | :--: | :--: | :---------------------------------------------------- |
| will-report-and-limit |  w   | 캐시 | 캐시는 사용량을 보고하고 모든 사용 제한에 복종        |
|      wont-report      |  x   | 캐시 | 캐시는 사용 제한에 복종하지만 사용량 보고는 하지 않음 |
|      wont-limit       |  y   | 캐시 | 캐시는 사용량 보고를 하지만 사용 제한은 없음          |
|         count         |  c   | 캐시 | "사용횟수/재사용횟수" 보고 지시자                     |
|       max-uses        |  u   | 서버 | 서버가 캐시를 사용해서 응답할 수 있는 최대 횟수       |
|      max-reuses       |  r   | 서버 | 서버가 캐시를 재사용해서 응답할 수 있는 최대 횟수     |
|       do-report       |  d   | 서버 | 서버가 프록시에게 사용량 보고 요구                    |
|      dont-report      |  e   | 서버 | 서버가 사용량 보고를 원치 않음                        |
|        timeout        |  t   | 서버 | 리소스 계량에 시간 제한을 둠                          |
|       wont-ask        |  n   | 서버 | 서버가 계량 정보를 원치 않음                          |

※ 적중 계량에서 '재사용 횟수'는 클라이언트 요청을 재검증한 횟수, '사용 횟수'는 요청에 응답한 횟수

- Meter 헤더는 프록시의 요청과 서버의 응답에 담김
- 프록시는 적중 계량을 할 수 있다고 서버에게 알리고, 서버는 프록시에게 적중 횟수를 요구

<br>

## 4. 개인 정보 보호에 대해

- 많은 사용자들이 자신의 HTTP 트랜잭션이 로깅되고 있다는 것을 모를 수 있음
- 그러므로 로깅하는 웹 서버와 프록시는 최종 사용자의 개인 정보 보호에 힘써야 함
- 로깅은 사용자들의 인지나 허가가 없으면 사생활 침해가 된다는 것을 유념할 것